<link rel="stylesheet" type="text/css" href="../../../assets/css/minimal.css">
<style type="text/css">
  #bottomButton {
    width: 100%;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
  }

  #next {
    padding: 16px;
    max-width: 388px;
    max-height: 48px;
    box-sizing: border-box;
    margin: 20px 0;
  }

  .twitter-typeahead,
  .tt-hint,
  .tt-input,
  .tt-menu {
    width: 100%;
  }

  .tt-menu {
    width: 300px;
  }

  .tt-suggestion {
    padding: 10px 20px;
    border-bottom: 1px solid #ccc;
    cursor: pointer;
  }

  .tt-suggestion:hover {
    color: white;
    background-color: #0097cf;
  }

  .tt-suggestion:last-child {
    border-bottom: none;
  }

  .tt-dataset {
    border: 1px solid #ccc;
    border-radius: 8px;
    background-color: white;
  }
</style>
<script type="application/javascript">
  Homey.setTitle("Hei! Velkommen til renovasjon i Homey!");
  Homey.setSubtitle("Før vi kan komme i gang må vi vite hvor du bor.");
</script>
<header class="homey-header">
  <h1 class="homey-title">
    <!-- This will be filled with the translated string with key 'settings.title'. -->
  </h1>
  <p class="homey-subtitle">
    <!-- This will be filled with the translated string with key 'settings.subtitle'. -->
  </p>
</header>
<fieldset class="homey-form-fieldset">
  <div id="step1">
    <label for="autocomplete" class="homey-form-label"><span data-i18n="renovation.pair.info.autoAddress"></span></label>
    <input class="homey-form-input" id="googleAutocomplete" type="text" placeholder="Søk etter adresse hos Google...">
    <input class="homey-form-input" id="kartverketAutocomplete" type="text"
      placeholder="Søk etter adresse hos Kartverket..." style="display: none;">
    <hr>
    <legend class="homey-form-legend">Finner du ikke adressen din?</legend>
    <button id="kartverketApi" class="homey-button-primary-full" style="margin-top: 5px;">Bruk Kartverket API</button>
  </div>
  <div id="step2" style="display: none;">
    <div class="homey-spinner"></div>
  </div>
  <div id="step3" style="display: none;">
    <div class="homey-form">
      <div class="homey-form-group">
        <label for="showProvider" class="homey-form-label">Leverandør</label>
        <input type="text" id="showProvider" class="homey-form-input" disabled />
        <label for="showAddressID" class="homey-form-label">Adresse-ID hos leverandør</label>
        <input type="text" id="showAddressID" class="homey-form-input" disabled />
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label">Stemmer informasjonen over?</label>
        <button id="ja" class="homey-button-primary">Ja</button>
        <button id="nei" class="homey-button-danger-shadow">Nei</button>
      </div>
    </div>
  </div>
  <div id="step4" style="display: none;">
    <div class="homey-form-group">
      <select id="provider-select" class="homey-form-select">
        <!-- Fylles med leverandører fra leverandør -->
        <option value="" disabled selected>Velg din leverandør</option>
      </select>
    </div>
    <button id="step4-next" class="homey-button-primary-full">Neste</button>
  </div>
  <div id="step4-multiple" style="display: none;">
    <div class="homey-form-group">
      <label class="homey-form-label" for="address-select">Velg din adresse</label>
      <select class="homey-form-select" id="address-select">
        <!-- Fylles med adresser fra leverandør -->
      </select>
    </div>
  </div>
  <div id="step5" style="display: none;">
    <div class="spinner"></div>
  </div>
  <div id="step6" style="display: none;">
    <!--<img src="https://gifdb.com/images/high/little-tiny-kitten-cat-crying-gc8r50a735w9bl3m.gif" alt="Sad cat"
      style="max-width: 100%; max-height: 100%;" />-->
    <img src="https://gifdb.com/images/high/programming-life-production-errors-995cfi9q78tj80e3.gif" alt="Error"
      style="object-fit: contain; max-width: 100%;" />
  </div>
  <div id="step7" style="display: none;">
    <div class="homey-form">
      <div class="homey-form-group">
        <div id="calendar"></div>
      </div>
      <div class="homey-form-group">
        <button id="step7-done" class="homey-button-primary-full">Neste</button>
      </div>
    </div>
  </div>
  <form>
    <input type="hidden" id="streetName" />
    <input type="hidden" id="houseNumber" />
    <input type="hidden" id="postCode" />
    <input type="hidden" id="countyID" />
    <input type="hidden" id="addressID" />
    <input type="hidden" id="addressCode" />
    <input type="hidden" id="provider" />
  </form>
</fieldset>
<div id="bottomButton">
  <button id="next" class="homey-button-primary-full" style="display: none;">Neste</button>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="../../../assets/js/index.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"
  integrity="sha512-CryKbMe7sjSCDPl18jtJI5DR5jtkUWxPXWaLCst6QjH8wxDexfRJic2WRmRXmstr2Y8SxDDWuBO6CQC6IE4KTA=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBIDkR54zKoltbl10PeJIp_g5bifxXwaDk&libraries=places&callback=initAutocomplete">
  </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>
<script type="text/javascript">
  $(document).ready(function () {
    var timeoutId;

    setTimeout(function () {
      $('#kartverketAutocomplete').typeahead({
        highlight: true,
      },
        {
          name: 'adresser',
          display: 'value',
          source: function (query, syncResults, asyncResults) {
            // Clear old timeout if it exists
            if (timeoutId) {
              clearTimeout(timeoutId);
            }

            // Set a new timeout
            timeoutId = setTimeout(function () {
              $.get(`https://ws.geonorge.no/adresser/v1/sok?sok=${query}&fuzzy=false&utkoordsys=4258&treffPerSide=10&side=0&asciiKompatibel=true`, function (data) {
                // Transform data here before passing to asyncResults
                let transformedData = data.adresser.map(function (address) {
                  return {
                    value: `${address.adressetekst}, ${address.postnummer} ${address.poststed}`,
                    adresseNavn: address.adressenavn,
                    adresseTekst: address.adressetekst,
                    adresseNummer: address.nummer,
                    adresseBokstav: address.bokstav,
                    adresseKode: address.adressekode,
                    kommuneNummer: address.kommunenummer,
                    kommuneNavn: address.kommunenavn,
                    postNummer: address.postnummer,
                    postSted: address.poststed,
                  };
                });
                asyncResults(transformedData);
              });
            }, 200);
          }
        });

      $('#kartverketAutocomplete').bind('typeahead:selected', function (obj, datum, name) {
        document.getElementById('streetName').value = datum.adresseNavn;
        document.getElementById('houseNumber').value = `${datum.adresseNummer}${datum.adresseBokstav ? datum.adresseBokstav : ''}`;
        document.getElementById('postCode').value = datum.postNummer;
        this.address = {
          "streetName": document.getElementById('streetName').value,
          "houseNumber": document.getElementById('houseNumber').value,
          "postCode": document.getElementById('postCode').value,
        }

        const update = settingsChanged(this.address);
        if (update == true) {
          console.log('Settings updated!');
          $('#next').show();
        }
      });
    }, 1000);
  });
</script>
<script>
  function initAutocomplete() {
    var address = document.getElementById('googleAutocomplete');
    var options = {
      componentRestrictions: { country: ['no'] }
    };

    var autocomplete = new google.maps.places.Autocomplete(address, options);

    autocomplete.addListener('place_changed', function () {
      var place = autocomplete.getPlace();
      console.log(place);

      const streetName = place.address_components.find(element => element.types.includes('route'));
      const houseNumber = place.address_components.find(element => element.types.includes('street_number'));
      const postCode = place.address_components.find(element => element.types.includes('postal_code'));

      if (streetName && houseNumber && postCode) {
        document.getElementById('streetName').value = streetName.long_name;
        document.getElementById('houseNumber').value = houseNumber.long_name;
        document.getElementById('postCode').value = postCode.long_name;
        this.address = {
          "streetName": streetName.long_name,
          "houseNumber": houseNumber.long_name,
          "postCode": postCode.long_name,
        }

        const update = settingsChanged(this.address);
        if (update == true) {
          console.log('Settings updated!');
          $('#next').show();
        }
      } else {
        console.log('No street name, house number or post code found!');
      }
    });
  }
</script>
<script type="text/javascript">
  $(document).ready(function () {
    Homey.emit('getProviders').then(function (result) {
      for (let i = 0; i < result.length; i++) {
        $('#provider-select').append(`<option value="${result[i].provider}">${result[i].provider}</option>`);
      }
      return true;
    });
  });

  function settingsChanged(value) {
    Homey.emit("settingsChanged", value).then(function (result) {
      console.log(result);
      return true;
    });
    return true;
  }

  function changeTitle(title, subtitle) {
    Homey.setTitle(title);
    Homey.setSubtitle(subtitle);
    return true;
  }

  async function checkAddress(address) {
    console.log(`Checking address: ${JSON.stringify(address)}`);
    return await Homey.emit('checkAddress', address);
  }

  async function getCalendar(address) {
    console.log(`Getting calendar for address: ${JSON.stringify(address)}`);
    return await Homey.emit('getCalendar', address);
  }

  //Emit til Homey for å bruke Homey sin lokasjon for å finne adresse
  async function useHomeyLocation() {
    console.log('Getting Homey location...');
    return await Homey.emit('useHomeyLocation');
  }

  $('#useHomeyLocation').click(async function () {
    const location = await useHomeyLocation();
    console.log(location);
    if (location.accuracy < 10) {
      console.log('Location accuracy is good enough!');
    }
  });

  $(document).ready(function () {
    $('#useSecondaryAPI').show();
    $('#kartverketApi').click(async function () {
      //Vi toggler mellom de to APIene.
      $('#kartverketAutocomplete').toggle();
      $('#googleAutocomplete').toggle();

      //Sett ny tekst på knappen
      if ($('#kartverketApi').html() == 'Bruk Kartverket API') {
        $('#kartverketApi').html('Bruk Google API');
      } else {
        $('#kartverketApi').html('Bruk Kartverket API');
      }
    });
  });

  // Step 1
  $('#next').click(async function () {
    changeTitle('Søker etter din adresse i kartet...', 'Dette kan ta noen sekunder...');
    $('#step1').hide();
    $('#step2').show();
    $('#next').hide();

    Homey.showLoadingOverlay();

    const address = {
      "streetName": $('#streetName').val(),
      "houseNumber": $('#houseNumber').val(),
      "postCode": $('#postCode').val(),
    };
    console.log(address);

    try {
      const data = await Homey.emit('checkAddress', address);
      //Vi sjekker om data returnert er { doubleCheck: true }.
      console.log(data);
      console.log(data.addressID.length);
      //Vi sjekker om data.addressID er et array
      if (Array.isArray(data.addressID) && data.addressID.length > 1) {
        changeTitle('Fant flere adresser!', 'Vi fant flere adresser i kartet som matcher din adresse, men er ikke helt sikre på hvilken som er din. Vennligst velg din adresse fra listen under.');
        $('#step2').hide();
        $('#step4-multiple').show();
        Homey.hideLoadingOverlay();

        $('#address-select').empty();
        $('#address-select').append(`<option value="" disabled selected>Velg din adresse</option>`);
        data.addressID.forEach((address, index) => {
          $('#address-select').append(`
            <option value="${address.id}">${address.subTitle}</option>
          `);
        });
        //Vi registrerer når bruker klikker på et valg
        $('#address-select').change(function () {
          $('#addressID').val($(this).val());
          $('#showAddressID').val($(this).val());
          console.log($(this).val());

          $('#provider').val(data.provider);
          $('#showProvider').val(data.provider);

          if (data.provider == "Min Renovasjon") {
            $('#countyID').val(data.countyId);
            $('#addressCode').val(data.addressCode);
          }

          console.log(`AdresseID: ${$('#addressID').val()}\nLeverandør: ${$('#provider').val()}\nFylke: ${$('#countyID').val()}\nAdressekode: ${$('#addressCode').val()}\n
          ShowAdresseID: ${$('#showAddressID').val()}\nShowLeverandør: ${$('#showProvider').val()}`);

          $('#step4-multiple').hide();
          $('#step3').show();

          const address = {
            "streetName": $('#streetName').val(),
            "houseNumber": $('#houseNumber').val(),
            "postCode": $('#postCode').val(),
            "provider": $('#provider').val(),
            "addressID": $('#addressID').val(),
            "countyID": $('#countyID').val(),
            "addressCode": $('#addressCode').val(),
          };

          settingsChanged(address);

          changeTitle('Fant din adresse!', `Vi fant din adresse i kartet. Det ser ut som din leverandør er ${data.provider}. Er dette riktig?`);
        });

        return;
      }

      // Address found. Confirm provider.
      changeTitle('Fant din adresse!', `Vi fant din adresse i kartet. Det ser ut som din leverandør er ${data.provider}. Er dette riktig?`);

      $('#step2').hide();
      $('#step3').show();
      Homey.hideLoadingOverlay();

      $('#showProvider').val(data.provider);
      $('#showAddressID').val(data.addressID);

      if (data.provider == "Min Renovasjon") {
        $('#countyID').val(data.countyId);
        $('#addressCode').val(data.addressCode);
      }

      $('#addressID').val(data.addressID);
      $('#provider').val(data.provider);
    } catch (error) {
      console.log(error);
      // Address not found. Show error.
      Homey.setTitle('Feil i adresse!');
      Homey.setSubtitle('Beklager, vi fant ikke informasjon om din adresse. Det kan være at du har skrevet feil, eller at din adresse ikke er registrert i kartet.');
      Homey.hideLoadingOverlay();
      Homey.setNavigationClose();

      $('#streetName').val('');
      $('#houseNumber').val('');
      $('#postCode').val('');
      $('#addressID').val('');
      $('#provider').val('');
      $('#countyID').val('');
      $('#addressCode').val('');

      $('#step2').hide();
      $('#step6').show();
    }
  });

  // Incorrect provider. Show list of providers. Go to step 4.
  $('#nei').click(function () {
    console.log('Nei knapp trykket!')
    changeTitle('Ikke riktig leverandør?', 'Beklager at vi ikke fant riktig leverandør for deg... Men heldigvis kan du velge en selv! Velg din leverandør fra listen under.');
    //changeTitle('Ikke riktig leverandør?', 'Beklager at vi ikke fant riktig leverandør for deg... Prøv igjen, eller opprett et issue på GitHub.');

    $('#step3').hide();
    //$('#step4').show();
    $('#step4').show();
    //Homey.setNavigationClose();

    $('#addressID').val('');
    $('#provider').val('');
  });

  $('#provider-select').change(async function () {
    $('#provider').val($('#provider-select').val());
    $('#step4').hide();
    $('#step5').show();

    const address = {
      "streetName": $('#streetName').val(),
      "houseNumber": $('#houseNumber').val(),
      "postCode": $('#postCode').val(),
      "providerName": $('#provider').val(),
    };

    if (address.provider == "Min Renovasjon") {
      address.countyId = $('#countyID').val();
      address.addressCode = $('#addressCode').val();
    }

    try {
      //console.log(address);
      const data = await checkAddress(address);
      //console.log(data);
      if (Array.isArray(data.addressID) && data.addressID.length > 1) {
        changeTitle('Fant flere adresser!', 'Vi fant flere adresser i kartet som matcher din adresse, men er ikke helt sikre på hvilken som er din. Vennligst velg din adresse fra listen under.');
        $('#step2').hide();
        $('#step4-multiple').show();
        Homey.hideLoadingOverlay();

        $('#address-select').empty();
        $('#address-select').append(`<option value="" disabled selected>Velg din adresse</option>`);
        data.addressID.forEach((address, index) => {
          $('#address-select').append(`
            <option value="${address.id}">${address.subTitle}</option>
          `);
        });
        //Vi registrerer når bruker klikker på et valg
        $('#address-select').change(function () {
          $('#addressID').val($(this).val());
          $('#showAddressID').val($(this).val());
          console.log($(this).val());

          $('#provider').val(data.provider);
          $('#showProvider').val(data.provider);

          if (data.provider == "Min Renovasjon") {
            $('#countyID').val(data.countyId);
            $('#addressCode').val(data.addressCode);
          }

          console.log(`AdresseID: ${$('#addressID').val()}\nLeverandør: ${$('#provider').val()}\nFylke: ${$('#countyID').val()}\nAdressekode: ${$('#addressCode').val()}\n
          ShowAdresseID: ${$('#showAddressID').val()}\nShowLeverandør: ${$('#showProvider').val()}`);

          $('#step4-multiple').hide();
          $('#step3').show();

          const address = {
            "streetName": $('#streetName').val(),
            "houseNumber": $('#houseNumber').val(),
            "postCode": $('#postCode').val(),
            "provider": $('#provider').val(),
            "addressID": $('#addressID').val(),
            "countyID": $('#countyID').val(),
            "addressCode": $('#addressCode').val(),
          };

          settingsChanged(address);

          changeTitle('Fant din adresse!', `Vi fant din adresse i kartet. Det ser ut som din leverandør er ${data.provider}. Er dette riktig?`);
        });

        return;
      }

      if (data == false) {
        changeTitle('Ikke riktig leverandør?', 'Beklager at vi ikke fant riktig leverandør for deg... Men heldigvis kan du velge en selv! Velg din leverandør fra listen under.');
        $('#step5').hide();
        $('#step4').show();
      } else {
        $('#step5').hide();
        $('#step7').show();
        changeTitle('Nesten ferdig!', 'Vi er nesten ferdig! Nå skal vi bare sjekke at vi finner en tømmekalender for din adresse. Vennligst vent mens vi sjekker. Dette burde ikke ta mer enn 10 sekunder.');
        Homey.showLoadingOverlay();

        const addressID = data.addressID;
        const provider = data.provider;
        const address = {
          "provider": provider,
          "addressID": addressID,
        };

        $('#showAddressID').val(addressID);
        $('#showProvider').val(provider);

        if (address.provider == "Min Renovasjon") {
          address.countyId = $('#countyID').val();
          address.addressCode = $('#addressCode').val();
        }

        try {
          const data = await getCalendar(address);
          //console.log(data);
          $('#step5').hide();
          $('#step7').show();
          Homey.hideLoadingOverlay();

          changeTitle('Tømmekalender funnet!', 'Vi fant en tømmekalender for din adresse! Vennligst sjekk at den stemmer overens med din leverandørs tømmekalender.');

          const calendar = data.groupedWasteInfo;
          for (let i = 0; i < calendar.length; i++) {
            const date = calendar[i].date;
            const longWasteType = calendar[i].longWasteType;
            const formattedDate = moment(date).format('DD.MM.YYYY');
            $('#calendar').append(`<li>${longWasteType}: ${formattedDate}</li>`);
          }
          $('#step7-done').click(function () {
            Homey.nextView();
            const address = {
              "provider": $('#showProvider').val(),
              "addressID": $('#showAddressID').val(),
            };

            if (address.provider == "Min Renovasjon") {
              address.countyId = $('#countyID').val();
              address.addressCode = $('#addressCode').val();
            }
            settingsChanged(address);
          });
        } catch (error) {
          console.log(error);
          // Address not found. Show error.
          Homey.setTitle('Fant ikke tømmekalender!');
          Homey.setSubtitle('Beklager, vi fant ikke en tømmekalender for din adresse. Vennligst kontakt din leverandør for å få hjelp.');
          Homey.setNavigationClose();

          $('#step5').hide();
          $('#step6').show();
        }
      }
    } catch (error) {
      console.log(error);
      // Address not found. Show error.
      Homey.setTitle('Fant ikke tømmekalender!');
      Homey.setSubtitle('Beklager, vi fant ikke en tømmekalender for din adresse. Vennligst kontakt din leverandør for å få hjelp.');
      Homey.setNavigationClose();

      $('#step5').hide();
      $('#step6').show();

      $('#next').hide();
    }
  });

  // Confirm correct provider. Go to step 5.
  $('#ja').click(async function () {
    console.log('Ja knapp trykket!')
    changeTitle('Nesten ferdig!', 'Vi er nesten ferdig! Nå skal vi bare sjekke at vi finner en tømmekalender for din adresse. Vennligst vent mens vi sjekker. Dette burde ikke ta mer enn 10 sekunder.');

    $('#step3').hide();
    $('#step5').show();
    Homey.showLoadingOverlay();

    const address = {
      "provider": $('#showProvider').val(),
      "addressID": $('#showAddressID').val(),
    };

    if (address.provider == "Min Renovasjon") {
      address.countyId = $('#countyID').val();
      address.addressCode = $('#addressCode').val();
    }

    try {
      const data = await getCalendar(address);
      console.log(data);
      $('#step5').hide();
      $('#step7').show();
      Homey.hideLoadingOverlay();

      changeTitle('Tømmekalender funnet!', 'Vi fant en tømmekalender for din adresse! Vennligst sjekk at den stemmer overens med din leverandørs tømmekalender.');

      const calendar = data.groupedWasteInfo;
      for (let i = 0; i < calendar.length; i++) {
        const date = calendar[i].date;
        const longWasteType = calendar[i].longWasteType;
        const formattedDate = moment(date).format('DD.MM.YYYY');
        $('#calendar').append(`<li>${longWasteType}: ${formattedDate}</li>`);
      }
      $('#step7-done').click(function () {
        Homey.nextView();
        const address = {
          "provider": $('#showProvider').val(),
          "addressID": $('#showAddressID').val(),
        };

        if (address.provider == "Min Renovasjon") {
          address.countyId = $('#countyID').val();
          address.addressCode = $('#addressCode').val();
        }
        settingsChanged(address);
      });
    } catch (error) {
      console.log(error);
      // Address not found. Show error.
      Homey.setTitle('Fant ikke tømmekalender!');
      Homey.setSubtitle('Beklager, vi fant ikke en tømmekalender for din adresse. Vennligst kontakt din leverandør for å få hjelp.');
      Homey.setNavigationClose();

      $('#step5').hide();
      $('#step6').show();
    }
  });

  // Selected provider manually from list. Go to step 5.
  $('#step4-next').click(function () {
    $('#step4').hide();
    $('#step5').show();
  });
</script>
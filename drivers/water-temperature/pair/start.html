<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"
	integrity="sha512-nMNlpuaDPrqlEls3IX/Q56H36qvBASwb3ipuo3MxeWbsQB1881ox0cRv7UPTgBlriqoynt35KjEwgGUeUXIPnw=="
	crossorigin="anonymous" referrerpolicy="no-referrer" />
<header class="homey-header">
	<h1 class="homey-title">
		<!-- This will be filled with the translated string with key 'settings.title'. -->
	</h1>
	<p class="homey-subtitle">
		<!-- This will be filled with the translated string with key 'settings.subtitle'. -->
	</p>
</header>
<fieldset class="homey-form-fieldset">
	<div id="step1" class="homey-form-group">
		<label for="region" class="homey-form-label"><span data-i18n="waterTemp.pair.region"></span></label>
		<select id="region" style="width: 100%;"></select>
	</div>
	<div id="step2" class="homey-form-group" style="display:none;">
		<label for="bathingSpot" class="homey-form-label"><span data-i18n="waterTemperature.pair.label"></span></label>
		<select id="bathingSpot" style="width: 100%;"></select>
	</div>
</fieldset>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"
	integrity="sha512-2ImtlRlf2VVmiGZsjm9bEyhjGW4dU7B6TNwh/hx/iSByxNENtj3WVE6o/9Lj4TJeVXPi4bnOIMXFIJJAeufa0A=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="application/javascript">
	Homey.setTitle(Homey.__("waterTemperature.pair.title"));
	Homey.setSubtitle(Homey.__("waterTemperature.pair.desc"));
	$(document).ready(function () {
		setTimeout(function () {
			let regions;
			let coords;

			// Get user's location
			Homey.emit('getLocation').then(function (result) {
				coords = result;
			});

			// Haversine formula for calculating distance between two coordinates
			function haversineDistance(lat1, lon1, lat2, lon2) {
				const R = 6371; // Radius of Earth in km
				const dLat = (lat2 - lat1) * (Math.PI / 180);
				const dLon = (lon2 - lon1) * (Math.PI / 180);
				const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
					Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
					Math.sin(dLon / 2) * Math.sin(dLon / 2);
				const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
				return R * c;
			}

			// 1. Get regions and initialize region select
			Homey.emit("getRegions").then(function (result) {
				regions = result;
				$('#region').select2({
					placeholder: 'Velg region...',
					data: regions.map(item => ({
						id: item.id,
						text: item.name
					}))
				});
			});

			// 2. When region is selected, fetch bathing spots for that region
			$('#region').on('select2:select', async function (e) {
				const selectedRegion = e.params.data;
				$('#step1').hide();
				$('#step2').show();

				// Show loading in bathingSpot select
				const $bathingSpot = $('#bathingSpot');
				$bathingSpot.empty().append(new Option('Laster badeplasser...', '', true, true)).trigger('change');

				try {
					const tempData = await Homey.emit("getTemperatures", selectedRegion.id);
					$bathingSpot.empty();
					if (tempData && tempData.length > 0) {
						$bathingSpot.append(new Option('Velg en badeplass', '', true, true));
						tempData.forEach(spot => {
							let distanceText = '';
							if (coords && spot.location && spot.location.latitude && spot.location.longitude) {
								const distance = haversineDistance(
									coords.lat,
									coords.lon,
									spot.location.latitude,
									spot.location.longitude
								);
								distanceText = ` - ${distance.toFixed(2)} km`;
							}
							const option = new Option(
								`${spot.location.name} (${spot.temperature}Â°C)${distanceText}`,
								spot.id,
								false,
								false
							);
							// Store spot data for later use
							$(option).data('spot', spot);
							$bathingSpot.append(option);
						});
						$bathingSpot.select2({
							placeholder: 'Velg en badeplass...'
						});
					} else {
						$bathingSpot.append(new Option('Ingen badeplasser funnet', '', true, true));
					}
				} catch (error) {
					console.error('Error fetching water temperatures:', error);
					$bathingSpot.empty().append(new Option('Kunne ikke hente badeplasser', '', true, true));
				}
			});

			// 3. When bathing spot is selected, save it and continue
			$('#bathingSpot').on('select2:select', function (e) {
				const spotId = $(this).val();
				const option = $(this).find('option:selected');
				const spot = option.data('spot');
				if (!spot) return;
				const spotData = {
					id: spot.id,
					name: spot.location.name,
					region: spot.location.region ? spot.location.region.name : '',
					subregion: spot.location.subregion ? spot.location.subregion.name : '',
					position: spot.location.position,
					temperature: spot.temperature,
					time: spot.time,
					sourceDisplayName: spot.sourceDisplayName || 'yr.no'
				};
				Homey.emit('saveBathingSpot', spotData).then(function (result) {
					//if (result === true) {
						Homey.emit('list_devices').then(function () {
							Homey.nextView();
						});
					//}
				});
			});

			// 4. If bathing spot is changed, save it and continue
			$('#bathingSpot').on('change', function () {
				const spotId = $(this).val();
				const option = $(this).find('option:selected');
				const spot = option.data('spot');
				if (!spot) return;
				const spotData = {
					id: spot.id,
					name: spot.location.name,
					region: spot.location.region ? spot.location.region.name : '',
					subregion: spot.location.subregion ? spot.location.subregion.name : '',
					position: spot.position,
					temperature: spot.temperature,
					time: spot.time,
					sourceDisplayName: spot.sourceDisplayName || 'yr.no'
				};
				Homey.emit('saveBathingSpot', spotData).then(function (result) {
					if (result === true) {
						Homey.emit('list_devices').then(function () {
							Homey.nextView();
						});
					}
				});
			});

		});
	});
</script>